---
title: "Coral cover analysis"
author: "Mauricio Romero-Torres and Ana Palacio-Castro"
date: "January 29, 2020"
output:
  html_document:
    toc: true
    theme: united
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```


 R Code for GCB-19-0810
 
 * Title: Coral reef resilience to thermal stress in the Eastern Tropical Pacific
 * Authors: Mauricio Romero-Torres, Alberto Acosta, Eric A. Treml, Fernando A. Zapata, David A. Paz-García, Ana M. Palacio-Castro & James W. Porter
 * Version 3.1


```{r}
rm(list = ls())  # Remove all objects from memory

```

#  1. Influence of most intense ENSO events on the coral cover in the ETP

```{r}
library(ggplot2)
library(gridExtra)

ENSO_colours<-c("blue", "red") # Type of anomaly
my_colours<-c("#feb24c93", "#fb6a4a93", "#9e9ac893", "#a6d96a93") # Thermal regime

theme_set (theme_classic() + theme(panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"),
                              legend.position="none",
                              axis.text.x = element_text(angle = 90, vjust = 0.5),
                              plot.title = element_text(size=12, face="bold"),
                              #panel.border = element_rect(colour = "black", fill=NA, size=1)
                              panel.border = element_blank()
                              ))
```

# ENSO intensity in region 3 

### Figure 2a

```{r}

# Plot ENOS 1971 - 2014
  ENOS<-read.table(file="http://www.cpc.ncep.noaa.gov/data/indices/ersst5.nino.mth.81-10.ascii",header=TRUE)
  ENOS1982_2014 <-subset(ENOS, YR>1968 & YR<2015)   # subset from 1970-2014
  ENOS1982_2014$Date<-paste(ENOS1982_2014$YR, ENOS1982_2014$MON, sep = "-" )
  ENOS1982_2014$Date<-paste(ENOS1982_2014$Date, "15", sep = "-" )
  ENOS1982_2014$Date<-as.Date(ENOS1982_2014$Date, format = "%Y-%m-%d")
  ENOS1982_2014$Anomaly <- factor(ifelse(ENOS1982_2014$ANOM.3 >=0, "Positive", "Negative"))
  
  interp <- approx(ENOS1982_2014$Date, ENOS1982_2014$ANOM.3, n=10000)
  DataENSO <- data.frame(Date=interp$x, Anomaly3=interp$y)
  DataENSO$Anomaly <- factor(ifelse(DataENSO$Anomaly3>=0, "Positive", "Negative"))
      
ENSO<-ggplot(data=DataENSO, aes(x=Date, y=Anomaly3))+
  scale_x_continuous("",expand=c(0, 0))+
  scale_y_continuous("SST anomaly (ºC) in Niño.3",expand=c(0, 0))+
  geom_area(aes(fill=Anomaly), alpha=0.7)+
  scale_fill_manual(values=ENSO_colours) + labs(title="a")+
  geom_hline(yintercept=0, linetype="solid", color="black")+
  geom_line(position = "identity", size=0.3)+
  theme(axis.text.x=element_blank(),
        axis.title.x=element_blank(),
        axis.ticks.x = element_blank())+
  annotate("text", x = 1900, y = 2.0, label = "El Niño \n72-73", size=3)+
  annotate("text", x = 5600, y = 2.0, label = "El Niño \n82-83", size=3)+
  annotate("text", x = 11100, y = 2.0, label = "El Niño \n97-98", size=3)
ENSO

# ENSOb<-ggplot(data=ENOS1982_2014, aes(x=Date, y=ANOM.3))+
#   geom_hline(yintercept=0, linetype="solid", color="black")+
#   scale_x_date("", limit=c(as.Date("1969-01-15"), as.Date("2014-12-31")),
#                breaks= "12 months",
#                      expand=c(0, 0))+
#   scale_y_continuous("SST anomaly (ºC) in Niño.3",expand=c(0, 0))+
#   geom_area(aes(fill=Anomaly))+
#   geom_line(position = "identity")+
#   scale_fill_manual(values=ENSO_colours) + labs(title="(a)")
# ENSOb
```

# Coral Cover trends in the ETP

## Coral cover data

* Select coral cover data and convert variable types

```{r}
# Select data
  cover <- read.csv("Data/Coral_Cover_ETP.csv", header=TRUE) # Select file: Coral_Cover_ETP.csv
  
# Convert to numeric variable the response variable and convert to nominal variables the factors
  cover$Coral_cover <- as.numeric(cover$Coral_cover) # convert to numeric variable
  cover$Region <- as.factor(cover$Region)               # convert to nominal factors
  cover$Location <- as.factor(cover$Location)
  cover$Site <- as.factor(cover$Site) 
  cover$Country <- as.factor(cover$Country)
  cover$Thermal_regime <- factor(cover$Thermal_regime, 
                                    levels=c("Thermally_Stable", "Upwelling", "Galapagos_Islands","Seasonal"),
                                    labels=c("Thermally stable", "Tropical upwelling", "Equatorial upwelling","Seasonal"))
  cover$Lat <- as.numeric(cover$Lat)
  cover$Lon <- as.numeric(cover$Lon)
  cover$Year <- as.numeric(cover$Year)
  #cover$Year <- as.numeric((cover$Year)-1970)  # transform years to begin in 0
  summary(cover)
```

## Data aggreation

* Hierarchically aggregate by Site, Location and Region
* Create time-intervals, and
* Exclude regions with cero and only one observation of coral cover per time-interval

```{r}
# Aggregate by site
  aggr.site <- aggregate(Coral_cover ~ Year+Region+Location+Site+Period_ENOS+Thermal_regime,FUN=mean,data=cover)
# Aggregate by location
  aggr.location <- aggregate(Coral_cover~Year+Region+Location+Period_ENOS+Thermal_regime,FUN=mean,data=aggr.site)
# Aggregate by region
  aggr.region <- aggregate(Coral_cover~Year+Region+Period_ENOS+Thermal_regime,FUN=mean,data=aggr.location)

# Create groups for each of three ENSO time-intervals  
  ENSO.73_82 <- subset(aggr.region, Period_ENOS == "1973-1982")
  ENSO.83_97 <- subset(aggr.region, Period_ENOS == "1983-1997")
  ENSO.98_14 <- subset(aggr.region, Period_ENOS == "1998-2016")

# Exclude regions with cero and only one observation of coral cover per time-interval
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Costa_Rica_Central", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "El_Salvador", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Western_Galapagos_Islands", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Clipperton", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Mexican_Southern", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Northern_Galapagos_Islands", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Clipperton", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "El_Salvador", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Western_Galapagos_Islands", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Revillagigedo_Islands", ]  
  
  ENSO.83_14 <- rbind(ENSO.83_97,ENSO.98_14)   # Second and third time intervals
  ENSO.73_14 <- rbind(ENSO.73_82,ENSO.83_14)   # First, second and third time intervals
  ENSO.73_97 <- rbind(ENSO.73_82,ENSO.83_97)   # First and second and time intervals
```

## Generalized Linear Mixed Model design and hypothesis testing  
* Coral_cover= response variable
* Region = repeated measure "subject" or repeated experimental unit (random factor)
* Year = continuous numeric variable
* Thermal_regime = fixed factor
  
```{r, message=FALSE}
library(nlme)
```

### Model 1: All years 1970_2014 

```{r}
# All years 1970_2014 
  model1 <- lme(
    Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=aggr.region)

  summary(model1)
  anova(model1)
  plot(ranef(model1))    # shows symmetrical scatter effects around zero
  plot(model1)           # plot residuals vs fitted
  resnorm1 <- resid(model1)
  hist(resnorm1, xlab = "Residuals", main = "") # residuals are normally distributed?
  coef.m1 <- as.data.frame(coef(summary(model1)))    # Coefficients of the model
  
  plot(model1, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
  plot(model1, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
  plot(model1, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
  plot(model1, Coral_cover ~ fitted(.), abline = c(0,1))
  
```

#### Figure 2b

```{r, warning=FALSE}
#Using raw data (Only thermal regime is significant in model)

Model1_plot <- ggplot(aggr.region, aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) + ylim(0,79) +
  scale_y_continuous("Live coral cover (%)", limits = c(-2, 80), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="b")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
Model1_plot
```

### Model 2: Time-interval 1 - ENSO.73_82

```{r}
# Time-interval 1 - ENSO.73_82
    model2 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.73_82) 
    summary(model2)
    anova(model2)
    plot(ranef(model2))    
    plot(model2)           
    resnorm2 <- resid(model2)
    hist(resnorm2, xlab = "Residuals", main = "") 
    coef.m2 <- as.data.frame(coef(summary(model2)))    
    
    plot(model2, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model2, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model2, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
```


*Note that this first time interval has low number of regions at each year, even the GLMM model is adjusted, please warning with interpretation/generalization of results*
    
#### Figure 2c

```{r, warning=FALSE}

#Using raw data (the model is not significant)

Model2_plot <- ggplot(ENSO.73_82, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", alpha=1, size=2)+ 
  geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) + 
  scale_y_continuous("Live coral cover (%)", limits = c(0, 80))+
  scale_x_continuous("", limits = c(1973.7, 1982.3),
                     breaks = seq(1974, 1982, by=2), expand = c(0.02,0.02))+
  scale_fill_manual(values=my_colours) +
  scale_colour_manual(values=my_colours)+
  labs(title="c")
Model2_plot

```

### Model 3: Time-interval 2 - ENSO.83_97

```{r}
# Time-interval 3 - ENSO.83_97
    model3 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.83_97) 
    summary(model3)
    anova(model3)
    plot(ranef(model3)) 
    plot(model3)           
    resnorm3 <- resid(model3)
    hist(resnorm3, xlab = "Residuals", main = "") 
    coef.m3 <- as.data.frame(coef(summary(model3)))    
    
    plot(model3, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model3, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model3, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
```

* Extract model 3 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_3 <- expand.grid(Thermal_regime=unique(ENSO.83_97$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.83_97$Year)), (max(ENSO.83_97$Year))))

pred_3 <- predict(model3, newdata=NewData_3, level=0, asList = FALSE)

```

#### Figure 2d

```{r, warning=FALSE}

# Using model data 
    Model3b_plot <- ggplot(ENSO.83_97, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
          shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) + 
          scale_y_continuous(" ", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1982.7, 1997.3), 
                             breaks = seq(1983, 1997, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_3, 
                    aes(y=predict(model3, level=0, newdata=NewData_3)), size=2) +
          theme(axis.text.y=element_blank(),  
                    axis.title.y=element_blank(),
                    legend.position = c(0.58, -0.4),
                    legend.title=element_blank(), 
                    legend.text=element_text(size=6),
                    legend.box ="horizontal")+
          guides(col = guide_legend(nrow = 2))+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+
          labs(title="d")
    Model3b_plot

```

### Model 4: Time-interval 3 - ENSO.98_14

```{r}
# Time-interval 4 - ENSO.98_14
    model4 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.98_14) 
    summary(model4)
    anova(model4)
    plot(ranef(model4))    
    plot(model4)           
    resnorm4 <- resid(model4)
    hist(resnorm4, xlab = "Residuals", main = "") 
    coef.m4 <- as.data.frame(coef(summary(model4)))    
    
    plot(model4, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model4, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model4, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
# Competing model with autocorrelation structure
    model4b <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, 
                   data=ENSO.98_14, correlation=corCompSymm(form=~Year|Region)) 
    
    anova(model4, model4b)  # ~ same results
```

* Extract model 4 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_4 <- expand.grid(Thermal_regime=unique(ENSO.98_14$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.98_14$Year)), (max(ENSO.98_14$Year))))

pred_4 <- predict(model4, newdata=NewData_4, level=0)

#summary(pred) 
#length(pred)
```

#### Figure 2e

```{r, warning=FALSE}
# Using model data 
    Model4b_plot <- ggplot(ENSO.98_14, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) +
          scale_y_continuous(" ", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1997.7, 2014.3),
                     breaks = seq(1998, 2014, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_4, aes(y=predict(model4, level=0, newdata=NewData_4)), size=2)+
          theme(axis.text.y=element_blank(), axis.title.y=element_blank())+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+    
          labs(title="e")
    Model4b_plot
    
    ```

### Model 5: Time-interval 4 - ENSO.83_14

```{r}
# Time-interval 5 - ENSO.83_14  
    model5 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.83_14) 
    summary(model5)
    anova(model5)
    plot(ranef(model5))    
    plot(model5)           
    resnorm5 <- resid(model5)
    hist(resnorm5, xlab = "Residuals", main = "") 
    coef.m5 <- as.data.frame(coef(summary(model5))) 
    
    plot(model5, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model5, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model5, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))

```

* Extract model 5 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_5 <- expand.grid(Thermal_regime=unique(ENSO.83_14$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.83_14$Year)), (max(ENSO.83_14$Year))))

pred_5 <- predict(model5, newdata=NewData_5, level=0) # level zero=population predictions

```

* Model 5 prediction

```{r, warning=FALSE}
# Using model data 
    Model5b_plot <- ggplot(ENSO.83_14, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) +
          scale_y_continuous("Live coral cover (%)", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1982.7, 2014.3),
                     breaks = seq(1983, 2014, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_5, aes(y=predict(model5, level=0, newdata=NewData_5)), size=2)+
          theme(axis.text.y=element_blank(),  
                    axis.title.y=element_blank(),
                    legend.position = c(0.58, -0.3),
                    legend.title=element_blank(), 
                    legend.text=element_text(size=6),
                    legend.direction="horizontal")+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+    
          labs(title="Model 5")
    Model5b_plot
    
```

##  Coral cover multiple comparison between years
* Adjusted p-values for all-pairwise comparisons in a one-way layout
* Set up ANOVA model
* Set up multiple comparisons object for all-pair comparisons
* Multiple comparisons after GLM including interaction terms
*Note:* Year is treated as a factor and not as a continous variable

```{r, message=FALSE}
library(multcomp)
library(lme4)
```

* Year 1982 vs 1983 (codes 12 vs 13)

```{r}
ENSO.73_97$Year_F <- as.factor(ENSO.73_97$Year)
comp_years_ENSO.73_97 <- aov(Coral_cover ~ Year_F + Thermal_regime, data = ENSO.73_97)
m.comp_ENSO.73_97 <- glht(comp_years_ENSO.73_97, linfct = mcp(Year_F = "Tukey"))
summary(m.comp_ENSO.73_97, test = univariate())

comp_years_ENSO.73_97 <- lmer(Coral_cover ~ Year_F + Thermal_regime + (1|Region), data = ENSO.73_97)
m.comp_ENSO.73_97 <- glht(comp_years_ENSO.73_97, linfct = mcp(Year_F = "Tukey"))
summary(m.comp_ENSO.73_97, test = univariate())

```

* Year 1983 vs 1997 (codes 13 vs 27), and 1997 vs 1998  (codes 27 vs 28)

```{r}
ENSO.83_97$Year_F <- as.factor(ENSO.83_97$Year)
comp_years_ENSO.83_97 <- aov(Coral_cover ~ Year_F + Thermal_regime, data = ENSO.83_97)
m.comp_ENSO.83_97 <- glht(comp_years_ENSO.83_97, linfct = mcp(Year_F = "Tukey"))
summary(m.comp_ENSO.83_97, test = univariate())

comp_years_ENSO.83_97 <- lmer(Coral_cover ~ Year_F + Thermal_regime + (1|Region), data = ENSO.83_97)
m.comp_ENSO.83_97 <- glht(comp_years_ENSO.83_97, linfct = mcp(Year_F = "Tukey"))
summary(m.comp_ENSO.83_97, test = univariate())

```

### FIGURE 2

```{r, warning=FALSE}

Figure2<-grid.arrange(ENSO, Model1_plot, arrangeGrob(
  Model2_plot, Model3b_plot, Model4b_plot, widths = c(3.9/12, 3.80/12, 4.30/12), ncol = 3),
             nrow=3) 
#ggsave(file="Fig1_V7.svg", plot=Figure2, width=6.69, height=6.69)

```

**FIGURE 2**  Illustration of the influence of most intense ENSO events on the coral cover in the ETP. **(a)** The upper panel indicates the positive (red) and negative (blue) SST anomalies in the Niño-3 region during 1971–2014 (NOAA Climate Prediction Center’s Extended Reconstructed Sea Surface Temperature ERSSTv5). The vertical orange bars indicate the strongest El Niño events. **(b)** The panel displays, at the horizontal axis, the 44-year live-coral cover aggregated at the region scale (n = 202) for ETP coral reefs with its fitted linear trend (gray dashed band). The fitted smooth line trend represents the long-term cycles of loss and recovery (blue line with the best polynomial fit with a 95% confidence level interval and a span = 0.2). The vertical axis shows the live coral cover. Box plots describe the minimum, maximum, interquartile ranges and median values of live-coral cover for each year. Notice the abrupt decrease in coral cover after 1982–83 El Niño; a smaller decline occurred after 1997–98. Random intercepts and random slopes models for the time-intervals: **(c)** 1974–1982, **(d)**1983–1997, and (e)1998–2014.


# 2. DHW and coral cover change

```{r, message=FALSE}
# Load packages 
library(tidyverse)
library(dplyr)
library(data.table)
```

## 2.1 Yearly maximum DHW experienced by the best-represented coral reefs sites from 1982 to 2014

* Select and transform DHW data

```{r}
# Select DHW data file: maxDHW.csv
  dhw <- read.csv("Data/maxDHW.csv", header=TRUE)

# Exclude years 1981, and 2017-2019
  dhw <- dhw[!dhw$Year == 1981, ]

# Create groups for plot
  ts.Cano_island <- subset(dhw, dhw$Site == "Cano_island")     
  ts.Uva_island <- subset(dhw, dhw$Site == "Uva_Island")          
  ts.Gorgona_island <- subset(dhw, dhw$Site == "Gorgona_Island")          
  ts.Darwin_island <- subset(dhw, dhw$Site == "Darwin_North_Anchorage")          
  ts.Bahia_Banderas <- subset(dhw, dhw$Site == "Bahia_Banderas")
  
  dhw.best.represented<-rbind(ts.Cano_island, ts.Uva_island, ts.Gorgona_island, 
                              ts.Darwin_island, ts.Bahia_Banderas)
  

```

### FIGURE 3a

* Plot max DHW in each location

```{r}

dhw.best.represented$Thermal_regime<-factor(dhw.best.represented$Site, levels =
                              c("Darwin_North_Anchorage",  "Cano_island", "Uva_Island", "Gorgona_Island", "Bahia_Banderas"))


# Figure 3a
Figure3a<-ggplot(dhw.best.represented, aes(x=Year, y=maxDHW,
                                 colour=Thermal_regime)) + theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = c(0.8,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size=8))+
  ggtitle("a") +
  scale_x_continuous(limits = c(1982,2014),
                     breaks = seq(1982,2014, 1),
                     expand = c(0.05 , 0.05),
                      "Years")+
  scale_y_continuous(limits = c(0, 28),
                     breaks = seq(0,28, 4),
                    "Degree heating weeks (°C-weeks)")+
  
  annotate("rect", xmin = 1982, xmax = 1983.5, ymin = 0, ymax = 28, fill="#fee8c8", alpha = .3)+
  annotate("rect", xmin = 1997, xmax = 1998.5, ymin = 0, ymax = 28, fill="#fee8c8", alpha = .3)+
  geom_hline(yintercept=4, linetype=2)+
  geom_hline(yintercept = 8, linetype=2)+
  geom_line() +
  scale_colour_manual(values=c("#9e9ac8",  "#8c2d04","#feb24c", "#fb6a4a", "#a6d96a"),
                    labels=c("Equatorial upwelling - Darwin Island",
                              "Thermally stable - Caño Island", 
                              "Thermally stable - Uva Island", 
                              "Tropical upwelling - Gorgona Island",
                              "Seasonal - Bahía Banderas"))
```

## 2.2 Relationship of coral cover rate of change and thermal stress 

* The DHW index measures the accumulated thermal stress above a bleaching threshold for 12 consecutive weeks. 
* At each site, the maximum monthly mean sea surface # temperature (MMM) is calculated from a long-term satellite climatology dataset. 
* Any temperature surpassing the MMM by 1ºC or more is added for 12 consecutive weeks, because temperatures ~1ºC above the MMM are known to cause coral bleaching (Liu et al., 2006).  
* For example, if the water temperature during four consecutive weeks exceeds the MMM in 1.3°C, # 1.1°C, 1.2°C, and 1.4°C, then, the site accumulates 5°C-weeks when these anomalies are summed. 

We tested the hypothesis that the strength of the *Log_annual_rate_of_change* (response variable) is a function of the *maxDHW* experienced. We had measured the rate of change from four Thermal regimes, and fitted Thermal regimes as a random intercept, and estimate a common slope (change in the rate of change) 
 for *maxDHW* across all Thermal regimes by fitting it as a fixed effect.

```{r, message=FALSE}
## Load data
  roc.cover <- read.csv("Data/RoC_DHW.csv", header=TRUE)  ### Select file:  RoC_DWH.csv

# Load packages
  library(lme4)
  library(lmerTest)
  library(MuMIn)
```

### Model 6: coral cover change and DHW 

```{r}
model6 <- lmerTest::lmer(Log_annual_rate_of_change ~ maxDHW + (1|Thermal_regime), data=roc.cover)
step(model6)
summary(model6) 
r.squaredGLMM(model6)   #  returns the marginal and the conditional R2
# marginal R2  describes the proportion of variance explained by the fixed factor(s) alone:
# conditional R2 describes the proportion of variance explained by both the fixed and random factors
# Nakagawa, S. & Schielzeth, H. (2013). 

```


### FIGURE 3b: Relationship of coral cover rate of change and thermal stress


```{r}

roc.cover$ENSO_Year<-factor(roc.cover$ENSO_Year, levels =
                              c("No", "1982-1984", "1997-1998"))
roc.cover$Thermal_regime<-factor(roc.cover$Thermal_regime, levels =
                              c("Galapagos_Islands", "Thermally_Stable", "Upwelling", "Seasonal"))

# Figure 3b
Figure3b<-ggplot(roc.cover, aes(x=maxDHW, y=(Log_annual_rate_of_change),
                                 fill=Thermal_regime, shape=ENSO_Year)) + 
  ggtitle("b") +
  scale_x_continuous(limits = c(0,30),
                     breaks = seq(0,30, 5),
                     expand = c(0.05 , 0.05),
                      "Degree heating weeks (°C-weeks)")+
  scale_y_continuous(limits = c(-1.7, 1),
                     breaks = seq(-1.5,1, 0.5),
    "Annual rate of change in coral cover")+
  geom_point(size=3, alpha=0.5) +
  geom_abline(slope = 0, intercept = 0, linetype=2)+
  geom_vline(xintercept=4, linetype=2)+
  geom_vline(xintercept = 8, linetype=2)+
  theme(legend.position = "right", 
        axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_fill_manual(values=c("#9e9ac893", "#feb24c93", "#fb6a4a93", "#a6d96a93"),
                     labels=c("Equatorial upwelling", "Thermally stable", "Tropical upwelling", "Seasonal"))+
  scale_shape_manual(values=c(21, 22, 24),
                     labels=c("No ENSO", "1982-1984", "1997-1998"))+
theme_bw() + theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  legend.text = element_text(size=8),
                  legend.title = element_blank(),
                  legend.position = c(0.65, 0.3))

# Figure3b

```

```{r}

grid.arrange(Figure3a, Figure3b, nrow = 1, widths = 2:1)
#ggsave(file="Figure_3.svg", dpi = 300, plot=grid.arrange(Figure3a, Figure3b, nrow = 1,
#widths = 2:1), width = 12, height = 4, units = "in")

```


**FIGURE 3** Heat stress and its effect on coral cover across the ETP. **(a)** The sequence of yearly maximum DHW experienced by the best-represented individual coral reefs sites from 1982 to 2014. When cumulative thermal stress reach 4°C-weeks and 8°C-weeks or higher (horizontal dotted lines), bleaching is likely, as well as coral mortality from thermal stress (Liu et al., 2006), respectively. Although the thresholds were developed in seasonal systems, and are not universally applicable for equatorial regions, they still useful for separating responses into groups. **(b)** The association between the maximum DHW and the coral cover change at each of four thermal regimes (dot colors as Fig. 2). Each point (n = 133) represents the DHW and the coral cover annual rate of change per individual coral reef site. The horizontal dotted line divides the positive (> 0) and the negative (< 0) rate of change caused by coral growth or mortality, respectively. The vertical dotted line indicates the DHW thresholds of 4°C-weeks and 8°C-weeks, respectively. The vertical and horizontal dotted lines create four response quadrants: I) heat stress and positive coral cover change (resilient response), II) no heat stress and positive coral cover change, III) no heat stress and negative coral cover change, and IV) heat stress and negative coral cover change.

## Descriptive statistics heat stress

No stress 

```{r}
no.stress <- subset(roc.cover, maxDHW < 4)                        # subset of DHW < 4
length(no.stress$maxDHW)/length(roc.cover$maxDHW)                 # ratio no stress: total              
1- length(no.stress$maxDHW)/length(roc.cover$maxDHW)              # ratio stress: total              
positive.rate <- subset(no.stress, Log_annual_rate_of_change > 0) # subset of Rate > 0
length(positive.rate$Log_annual_rate_of_change)                     # Number of observations in 
negative.rate <- subset(no.stress, Log_annual_rate_of_change < 0)   #subset of Rate > 0
length(negative.rate$Log_annual_rate_of_change)                     # Number of observations in 
```

No stress seasonal

```{r}
no.stress.seasonal <- subset(no.stress, Thermal_regime == "Seasonal")   
positive.rate <- subset(no.stress.seasonal, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.seasonal, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)   

```

No stress upwelling

```{r}
no.stress.upwelling <- subset(no.stress, Thermal_regime == "Upwelling")
positive.rate <- subset(no.stress.upwelling, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.upwelling, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

No stress thermally stable

```{r}
no.stress.Thermally_Stable <- subset(no.stress, Thermal_regime == "Thermally_Stable")   
positive.rate <- subset(no.stress.Thermally_Stable, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.Thermally_Stable, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

No stress Galapagos

```{r}
no.stress.Galapagos_Islands <- subset(no.stress, Thermal_regime == "Galapagos_Islands") 
positive.rate <- subset(no.stress.Galapagos_Islands, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.Galapagos_Islands, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

# 3. Supplementary figures

```{r, message=FALSE}
library(pals)
library(dplyr)
library(reshape2)
library(RColorBrewer) 
```

### FIGURE S1: Number of regionsand countries surveyed per year

```{r}
# Barplot number of surveys per year
  obs_num = as.data.frame(table(cover$Year,cover$Region))    
  colnames(obs_num) = c("Year", "Region", "Freq")
  wide_obs_num = dcast(obs_num, Region~Year, value = "Freq")  
  df = data.matrix(wide_obs_num[,2:45])   
  as.table(df)     
  df[ df>1 ] <- 1 
  levels(cover$Region) # How many regions? = how many colours
  Regions <- c(levels(obs_num$Region))
  color.regions = warmcool(17)
  
  # Figure 2a
  par(mfcol=c(2,1), cex.main = 1.5, mar = c(4,4,1,1), cex.lab = 1.5, cex.axis = 1,  las = 1)
  barplot(df,
          ylim=c(0,15),
          col = color.regions,   
          ylab="Number of regions surveyed per year",  
          xlab="Year",
          #lwd = 1,          
          las = 2,           
          axis.lty = 1, 
          cex.names = 0.4,   
          cex.axis = 0.8)
# Legend as a box
  legend( #"bottomright",    
     x = 2, y = 16, 
     xpd = NA,  # or TRUE 
     legend = Regions,          
     fill = color.regions[1:17],   
     inset=c(-0.5,0),
     cex = 0.35,
     text.font=0.5,            
     x.intersp = -0.5,
     y.intersp = 1,
     lwd = 0.1,
     bty="n")

# Figure 2b
obs_num = as.data.frame(table(cover$Year,cover$Country))    # Table per country
colnames(obs_num) = c("Year", "Country", "Freq")
wide_obs_num = dcast(obs_num, Country~Year, value = "Freq")   
dfc = data.matrix(wide_obs_num[,2:45])   
as.table(dfc)       
dfc[ dfc>1 ] <- 1 # replace all values greater than one with one
color.countries <- brewer.pal(9, "Oranges")
countries = c(levels(obs_num$Country))
barplot(dfc,
        col = color.countries,   
        ylim=c(0,10),
        ylab="Number of countries surveyed per year",  
        xlab="Year",
        las = 2,           
        axis.lty = 1,      
        cex.names = 0.4,   
        cex.axis = 0.8)
# Legend as a box
legend( #"bottomright",    
   x = 2, y = 10, 
   xpd = NA,  # or TRUE 
   legend = countries,         
   fill = color.countries[1:9],   
   inset=c(-0.5,0),
   cex = 0.35,
   text.font=1,            
   x.intersp = -0.5,
   y.intersp = 1,
   lwd = 0.1,
   bty="n")

```

```{r, include = FALSE}
 dev.off() # reset parameters for next plot 
```

**FIGURE S1** Regions and countries surveyed per year. **(a)** Number of regions surveyed per year in the ETP. Since 1970, the number of surveys in all regions increased by year up to a maximum of 10 regions surveyed in 2009. **(b)** Number of countries surveyed per year (Colombia, Costa Rica, Ecuador, El Salvador, France, Mexico, Nicaragua and Panama). Since 1970, the number of surveys in all the countries reached a maximum of 6 countries in 2009.


### FIGURE S2: Variation in the live coral cover for 1970–2014 per thermal regime 

Temporal variation in the live coral cover for 1970–2014.

* (a) Tropical upwelling regime. 
* (b) Seasonal regime. 
* (c) Thermally stable regime. 
* (d) Equatorial upwelling regime. 

The smooth line represents the best fit to the time series with a 95% confidence level interval and a span = 0.3.

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(lemon)

aggr.region_S2<-aggr.region
aggr.region_S2$Thermal_regime<-factor(aggr.region_S2$Thermal_regime, 
                                  levels=c("Tropical upwelling", "Seasonal", 
                                           "Thermally stable", "Equatorial upwelling"),
                                  labels = c ("a", "b", "c", "d"))
                                   

FigureS2<-ggplot(aggr.region_S2, aes(x=Year, y=Coral_cover)) + 
  theme_bw() + theme(panel.border = element_blank(),   # set ggplot to white background
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(),
                              strip.background = element_blank(),
                              strip.text = element_text(face="bold",hjust = 0, vjust = -1))+
  geom_point()+ geom_smooth (span = 0.3) +
  scale_x_continuous(limits=c(1970, 2014), 
                     breaks = seq(1970, 2014, by=5),
                     expand = c(0.01, 0.01), "Year") +
  scale_y_continuous(limits=c(-19, 91), expand = c(0, 0), "Live coral cover (%)") +
  facet_wrap(Thermal_regime~., ncol=1, scales = "free_x", strip.position ="top")

FigureS2
#ggsave(file="FigureS2.svg", plot=FigureS2, width=6.69, height=6.69)

```

**FIGURE S2** Temporal variation in the live coral cover for 1970–2014. **(a)** Tropical upwelling regime (n = 75). **(b)** Seasonal regime (n = 28). **(c)** Thermally stable regime (n = 74). **(d)** Equatorial upwelling regime (n = 25). The smooth line represents the best fit to the time series with a 95% confidence level interval and a span = 0.3.

```{r}
FigureS2b<-ggplot(cover, aes(x=Year, y=Coral_cover)) + 
  theme_bw() + theme(panel.border = element_blank(),   # set ggplot to white background
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(),
                              strip.background = element_blank(),
                              strip.text = element_text(face="bold",hjust = 0, vjust = -1))+
  geom_point(aes(colour=Region)) +
  geom_smooth (span = 0.3, colour="gray") +
  scale_x_continuous(limits=c(1970, 2014), 
                     breaks = seq(1970, 2014, by=5),
                     expand = c(0.01, 0.01), "Year") +
  scale_y_continuous(limits=c(-19, 91), expand = c(0, 0), "Live coral cover (%)") +
  facet_wrap(Thermal_regime~., ncol=1, scales = "free_x", strip.position ="top") +
  theme(legend.position = "bottom", legend.direction = "horizontal" )

FigureS2b
```

# 4. Revision figures

## Data only for four best monitoring sites

We found in published studies four comprehensive monitoring datasets for Uva Island, Gorgona Island, Costa Rica, and the Eastern and Northern Galapagos Islands, which correspond to well recognized long-term monitoring programs

```{r}
# Create groups
Uva_Island <- subset(aggr.site, Site == "Uva_Island")
Gorgona <-subset(aggr.site, Site == "La_Azufrada")
Cano_island <-subset(aggr.site, Site == "Cano_island")
EGI <-subset(aggr.site, Region == "Eastern_Galapagos_Islands")
NGI <-subset(aggr.site, Region == "Northern_Galapagos_Islands")

Monitoring_sites <- rbind(Uva_Island,Gorgona,Cano_island,EGI,NGI)

```

### Model 7: Only monitored sites

```{r}
model7 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=Monitoring_sites) 
summary(model7)
anova(model7)


plot(ranef(model7))    
plot(model7)           
resnorm7 <- resid(model7)
hist(resnorm7, xlab = "Residuals", main = "") 
coef.m7 <- as.data.frame(coef(summary(model7))) 
plot(model7, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
plot(model7, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
plot(model7, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))

```

### FIGURE S3: Data only for four best monitoring sites

```{r}
FigureS3 <-ggplot(Monitoring_sites, aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  scale_y_continuous("Live coral cover (%)", limits = c(-15, 95), 
                     breaks = seq(0, 90, by=20), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")

FigureS3

FigureS3b<- FigureS3 + geom_point(aes(colour=Location), alpha=0.4) +
  theme(legend.position = "bottom")
FigureS3b

#ggsave(file="FigS3.png", plot=FigureS3, width=6.69, height=4)
#ggsave(file="FigS3b.png", plot=FigureS3b, width=6.69, height=4.69)

```

## Data excluding one thermal regime from model 1

Model 1: All years (1970_2014) removing each termal regime 

* Tropical upwelling

```{r}
Model1_NoEquatorial_Upwelling <- ggplot(data=subset(aggr.region, Thermal_regime!="Tropical upwelling"), aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) +
  scale_y_continuous("Live coral cover (%)", limits = c(-5, 90), 
                     breaks = seq(0, 90, by=20), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="a")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
#Model1_NoEquatorial_Upwelling
```

* Seasonal

```{r}
Model1_NoSeasonal <- ggplot(data=subset(aggr.region, Thermal_regime!="Seasonal"), aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) +
  scale_y_continuous("Live coral cover (%)", limits = c(-5, 90),
                     breaks = seq(0, 90, by=20), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="b")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
#Model1_NoSeasonal
```

* Thermally stable

```{r}
Model1_NoThermallyStable <- ggplot(data=subset(aggr.region, Thermal_regime!="Thermally stable"), aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) +
  scale_y_continuous("Live coral cover (%)", limits = c(-5, 90),
                     breaks = seq(0, 90, by=20), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="c")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
# Model1_NoThermallyStable
```

* Equatorial upwelling

```{r}
Model1_No_EqUpwelling <- ggplot(data=subset(aggr.region, Thermal_regime!="Equatorial upwelling"), aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) +
  scale_y_continuous("Live coral cover (%)", limits = c(-5, 90), 
                     breaks = seq(0, 90, by=20), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="d")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
# Model1_No_EqUpwelling
```

### FIGURE S4: Effect of thermal regime removal/addition 

```{r}
FigureS4<-grid.arrange(Model1_NoEquatorial_Upwelling, Model1_NoSeasonal, 
                       Model1_NoThermallyStable, Model1_No_EqUpwelling,
                       ncol = 2)
#ggsave(file="FigS5.png", plot=FigureS5, width=6.69, height=6.69)
#ggsave(file="FigS5.pdf", plot=FigureS5, width=6.69, height=6.69)

```

**Figure S4:** Coral cover trends excluding **(a)** Thermally stable, **(b)** Tropical Upwelling, **(c)** Equatorial upwelling, and **(d)** Seasonal thermal regimes

## Add CI based on boostraping to fig 2?

To use "bootMer" models need to be run with lme4 instead nlme. Please check accuracy of the new (b) models

### Model 1b: All years 1970_2014 with lme4

```{r}
  # 1. Build lme4 model:
   
    model1b <- lmer(
      Coral_cover ~ Thermal_regime * Year + 
        (1|Region), data=aggr.region, REML = FALSE)
  
    summary(model1b)
    anova(model1b) # Thermal regime is not significant anymore?? 
    ranova(model1b) # Region seems the only significant effect
    drop1(model1b)
```

**Not sure if this if right since the model itself is not significant **

```{r}
  # 2. Predict values:
    pred1 <- predict(model1b,re.form = NA)

  #3. Bootstrap CI:
    boot1 <- bootMer(model1b, predict, nsim = 1000, re.form = NULL) # include random effects, reduce CI lot!
    std.err <- apply(boot1$t, 2, sd)
    CI.lo_1 <- pred1 - std.err*1.96
    CI.hi_1 <- pred1 + std.err*1.96

  #Plot
  Model1b_plot<- ggplot(
    aggr.region, aes(x = Year, y = Coral_cover, colour = Thermal_regime)) +
    geom_line(aes(y = pred1),size=2) +
    geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) +
    geom_ribbon(aes(ymin = CI.lo_1, ymax = CI.hi_1),
                size=2, alpha = 0.03, linetype = 0) +
    scale_color_manual(values=my_colours) +
    scale_fill_manual(values=my_colours) +
    scale_y_continuous("Live coral cover (%)", 
                       limits = c(-20, 90), 
                       breaks = seq(0, 90, by=20), expand = c(0,0))+
    scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))
  
  Model1b_plot
   
```

### Model 2b: Time-interval 1 - ENSO.73_82 with lme4

Not enough data

### Model 3b: Time-interval 2 - ENSO.83_97 with lme4

```{r}
  # 1. Build lme4 model:
   
    model3b <- lmer(
      Coral_cover ~ Thermal_regime * Year + 
        (1|Region), data=ENSO.83_97, REML = FALSE)
  
    summary(model3b)
    anova(model3b) # Thermal regime and its interaciton with year are significant 
    ranova(model3b) # ramdom effects are not 
    drop1(model3b)
  
  # 2. Predict values:
    pred3 <- predict(model3b,re.form = NA)

  #3. Bootstrap CI:
    boot3 <- bootMer(model3b, predict, nsim = 1000, re.form = NA) # No ramndom effects
    std.err <- apply(boot3$t, 2, sd)
    CI.lo_3 <- pred3 - std.err*1.96
    CI.hi_3 <- pred3 + std.err*1.96

  #Plot
    
   Model3b_plot<- ggplot(
     ENSO.83_97, aes(x = Year, y = Coral_cover, colour = Thermal_regime))+
    geom_line(aes(y = pred3),size=2) +
    geom_point(aes(fill=factor(Thermal_regime)),
          shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) + 
    geom_ribbon(aes(ymin = CI.lo_3, ymax = CI.hi_3),
                size=2, alpha = 0.03, linetype = 0) +
    scale_fill_manual(values=my_colours)+
    scale_colour_manual(values=my_colours) +
    scale_x_continuous("", limits = c(1982.7, 1998.2), 
                        breaks = seq(1983, 1997, by=2), 
                        expand = c(0.02,0.02))+
    scale_y_continuous("Live coral cover (%)", 
                       limits = c(-20, 90), 
                       breaks = seq(0, 90, by=20), expand = c(0,0))
    
   Model3b_plot
   

  #ggsave(file="Model3b_plot.png", plot=Model3b_plot, width=4, height=4)
  #ggsave(file="Model3b_plot.pdf", plot=Model3b_plot, width=4, height=4)
   
```

### Model 4b:  Time-interval 3 - ENSO.98_14 with lme4

```{r}
  # 1. Build lme4 model:
   
    model4b <- lmer(
      Coral_cover ~ Thermal_regime * Year + 
        (1|Region), data=ENSO.98_14, REML = FALSE)
  
    summary(model4b)
    anova(model4b) # Thermal regime and its interaciton with year are significant 
    ranova(model4b) # ramdom effects are significant
    drop1(model4b)
  
  # 2. Predict values:
    pred4 <- predict(model4b,re.form = NA)

  #3. Bootstrap CI:
    boot4 <- bootMer(model4b, predict, nsim = 1000, re.form = NULL) # Include ramndom effects
    std.err <- apply(boot4$t, 2, sd)
    CI.lo_4 <- pred4 - std.err*1.96
    CI.hi_4 <- pred4 + std.err*1.96

  #Plot
   Model4b_plot<- ggplot(ENSO.98_14, aes(
     x = Year, y = Coral_cover, colour = Thermal_regime)) +
    geom_line(aes(y = pred4),size=2) +
    geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, 
             stroke = 0.3, alpha=0.5) +
    geom_ribbon(aes(ymin = CI.lo_4, ymax = CI.hi_4),size=2, 
                alpha = 0.03, linetype = 0) +
    scale_y_continuous("Live coral cover (%)",
                       limits = c(-20, 90), 
                       breaks = seq(0, 90, by=20), expand = c(0,0))+
    scale_x_continuous("", limits = c(1997.7, 2014.3),
                     breaks = seq(1998, 2014, by=2), expand = c(0.02,0.02))+
   scale_color_manual(values=my_colours) +
   scale_fill_manual(values=my_colours)
   Model4b_plot
  #ggsave(file="Model4b_plot.png", plot=Model4b_plot, width=4, height=4)
  #ggsave(file="Model4b_plot.pdf", plot=Model4b_plot, width=4, height=4)
   
```

### Model 5b:  Time-interval 4 - ENSO.98_14 with lme4

```{r}
  # 1. Build lme4 model:
   
    model5b <- lmer(
      Coral_cover ~ Thermal_regime * Year + 
        (1|Region), data=ENSO.83_14, REML = FALSE)
  
    summary(model5b)
    anova(model5b) # Thermal regime and its interaciton with year are significant 
    ranova(model5b) # ramdom effects are significant
    drop1(model5b)
  
  # 2. Predict values:
    pred5 <- predict(model5b,re.form = NA)

  #3. Bootstrap CI:
    boot5 <- bootMer(model5b, predict, nsim = 1000, re.form = NULL) # Include ramndom effects
    std.err <- apply(boot5$t, 2, sd)
    CI.lo_5 <- pred5 - std.err*1.96
    CI.hi_5 <- pred5 + std.err*1.96

  #Plot
   Model5b_plot<- ggplot(ENSO.83_14, aes(
     x = Year, y = Coral_cover, colour = Thermal_regime)) +
    geom_line(aes(y = pred5),size=2) +
    geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, 
             stroke = 0.3, alpha=0.5) +
    geom_ribbon(aes(ymin = CI.lo_5, ymax = CI.hi_5),size=2, 
                alpha = 0.03, linetype = 0) +
    scale_y_continuous("Live coral cover (%)",
                       limits = c(-20, 90), 
                       breaks = seq(0, 90, by=20), expand = c(0,0))+
    scale_x_continuous("", limits = c(1983, 2014.3),
                     breaks = seq(1983, 2014, by=2), expand = c(0.02,0.02))+
   scale_color_manual(values=my_colours) +
   scale_fill_manual(values=my_colours)
   Model5b_plot
  #ggsave(file="Model4b_plot.png", plot=Model4b_plot, width=4, height=4)
  #ggsave(file="Model4b_plot.pdf", plot=Model4b_plot, width=4, height=4)
   
```
