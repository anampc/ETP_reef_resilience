---
title: "Coral cover analysis"
author: "Mauricio Romero-Torres and Ana Palacio-Castro"
date: "September 16, 2019"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


 R Code for GCB-19-0810
 
 * Title: Coral reef resilience to thermal stress in the Eastern Tropical Pacific
 * Authors: Mauricio Romero-Torres, Alberto Acosta, Eric A. Treml, Fernando A. Zapata, David A. Paz-García, Ana M. Palacio-Castro & James W. Porter
 * Version 3.0


```{r}
rm(list = ls())  # Remove all objects from memory

```

##  Influence of most intense ENSO events on the coral cover in the ETP

```{r}
library(ggplot2)
library(gridExtra)

ENSO_colours<-c("blue", "red") # Type of anomaly
my_colours<-c("#feb24c93", "#fb6a4a93", "#9e9ac893", "#a6d96a93") # Thermal regime

theme_set (theme_classic() + theme(panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"),
                              legend.position="none",
                              axis.text.x = element_text(angle = 90, vjust = 0.5),
                              plot.title = element_text(size=12, face="bold"),
                              #panel.border = element_rect(colour = "black", fill=NA, size=1)
                              panel.border = element_blank()
                              ))
```


# ENSO intensity in region 3 

## Figure 1a

```{r}

# Plot ENOS 1971 - 2014
  ENOS<-read.table(file="http://www.cpc.ncep.noaa.gov/data/indices/ersst5.nino.mth.81-10.ascii",header=TRUE)
  ENOS1982_2014 <-subset(ENOS, YR>1968 & YR<2015)   # subset from 1970-2014
  ENOS1982_2014$Date<-paste(ENOS1982_2014$YR, ENOS1982_2014$MON, sep = "-" )
  ENOS1982_2014$Date<-paste(ENOS1982_2014$Date, "15", sep = "-" )
  ENOS1982_2014$Date<-as.Date(ENOS1982_2014$Date, format = "%Y-%m-%d")
  ENOS1982_2014$Anomaly <- factor(ifelse(ENOS1982_2014$ANOM.3 >=0, "Positive", "Negative"))
  
  interp <- approx(ENOS1982_2014$Date, ENOS1982_2014$ANOM.3, n=10000)
  DataENSO <- data.frame(Date=interp$x, Anomaly3=interp$y)
  DataENSO$Anomaly <- factor(ifelse(DataENSO$Anomaly3>=0, "Positive", "Negative"))
      
ENSO<-ggplot(data=DataENSO, aes(x=Date, y=Anomaly3))+
  scale_x_continuous("",expand=c(0, 0))+
  scale_y_continuous("SST anomaly (ºC) in Niño.3",expand=c(0, 0))+
  geom_area(aes(fill=Anomaly), alpha=0.7)+
  scale_fill_manual(values=ENSO_colours) + labs(title="a")+
  geom_hline(yintercept=0, linetype="solid", color="black")+
  geom_line(position = "identity", size=0.3)+
  theme(axis.text.x=element_blank(),
        axis.title.x=element_blank(),
        axis.ticks.x = element_blank())+
  annotate("text", x = 1900, y = 2.0, label = "El Niño \n72-73", size=3)+
  annotate("text", x = 5600, y = 2.0, label = "El Niño \n82-83", size=3)+
  annotate("text", x = 11100, y = 2.0, label = "El Niño \n97-98", size=3)
ENSO

# ENSOb<-ggplot(data=ENOS1982_2014, aes(x=Date, y=ANOM.3))+
#   geom_hline(yintercept=0, linetype="solid", color="black")+
#   scale_x_date("", limit=c(as.Date("1969-01-15"), as.Date("2014-12-31")),
#                breaks= "12 months",
#                      expand=c(0, 0))+
#   scale_y_continuous("SST anomaly (ºC) in Niño.3",expand=c(0, 0))+
#   geom_area(aes(fill=Anomaly))+
#   geom_line(position = "identity")+
#   scale_fill_manual(values=ENSO_colours) + labs(title="(a)")
# ENSOb
```


# Coral Cover trends in the ETP

## Coral cover data

* Select coral cover data and convert variable types

```{r}
# Select data
  cover <- read.csv("Data/Coral_Cover_ETP.csv", header=TRUE) # Select file: Coral_Cover_ETP.csv
  
# Convert to numeric variable the response variable and convert to nominal variables the factors
  cover$Coral_cover <- as.numeric(cover$Coral_cover) # convert to numeric variable
  cover$Region <- as.factor(cover$Region)               # convert to nominal factors
  cover$Location <- as.factor(cover$Location)
  cover$Site <- as.factor(cover$Site) 
  cover$Country <- as.factor(cover$Country)
  cover$Thermal_regime <- factor(cover$Thermal_regime, 
                                    levels=c("Thermally_Stable", "Upwelling", "Galapagos_Islands","Seasonal"),
                                    labels=c("Thermally stable", "Tropical upwelling", "Equatorial upwelling","Seasonal"))
  cover$Lat <- as.numeric(cover$Lat)
  cover$Lon <- as.numeric(cover$Lon)
  cover$Year <- as.numeric(cover$Year)
  #cover$Year <- as.numeric((cover$Year)-1970)  # transform years to begin in 0
  summary(cover)
```

* Hierarchically aggregate by Site, Location and Region
* Create time-intervals, and
* Exclude regions with cero and only one observation of coral cover per time-interval

```{r}
# Aggregate by site
  aggr.site <- aggregate(Coral_cover ~ Year+Region+Location+Site+Period_ENOS+Thermal_regime,FUN=mean,data=cover)
# Aggregate by location
  aggr.location <- aggregate(Coral_cover~Year+Region+Location+Period_ENOS+Thermal_regime,FUN=mean,data=aggr.site)
# Aggregate by region
  aggr.region <- aggregate(Coral_cover~Year+Region+Period_ENOS+Thermal_regime,FUN=mean,data=aggr.location)

# Create groups for each of three ENSO time-intervals  
  ENSO.73_82 <- subset(aggr.region, Period_ENOS == "1973-1982")
  ENSO.83_97 <- subset(aggr.region, Period_ENOS == "1983-1997")
  ENSO.98_14 <- subset(aggr.region, Period_ENOS == "1998-2016")

# Exclude regions with cero and only one observation of coral cover per time-interval
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Costa_Rica_Central", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "El_Salvador", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Western_Galapagos_Islands", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Clipperton", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Mexican_Southern", ]  
  ENSO.83_97<- ENSO.83_97[!ENSO.83_97$Region == "Northern_Galapagos_Islands", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Clipperton", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "El_Salvador", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Western_Galapagos_Islands", ]  
  ENSO.98_14<- ENSO.98_14[!ENSO.98_14$Region == "Revillagigedo_Islands", ]  
  
  ENSO.83_14 <- rbind(ENSO.83_97,ENSO.98_14)   # Second and third time intervals
  ENSO.73_14 <- rbind(ENSO.73_82,ENSO.83_14)   # First, second and third time intervals
  ENSO.73_97 <- rbind(ENSO.73_82,ENSO.83_97)   # First and second and time intervals
```

## Generalized Linear Mixed Model design and hypothesis testing  
  
```{r, message=FALSE}
  
library(nlme)
# Coral_cover     = response variable
# Region          = repeated measure "subject" or repeated experimental unit (random factor)
# Year            = continuous numeric variable
# Thermal_regime  = fixed factor
```

### Model 1: All years 1970_2014 

```{r}
# All years 1970_2014 
  model1 <- lme(
    Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=aggr.region)

  summary(model1)
  anova(model1)
  plot(ranef(model1))    # shows symmetrical scatter effects around zero
  plot(model1)           # plot residuals  vs fitted
  resnorm1 <- resid(model1)
  hist(resnorm1, xlab = "Residuals", main = "") # residuals are normally distributed?
  coef.m1 <- as.data.frame(coef(summary(model1)))    # Coefficients of the model
  
  plot(model1, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
  plot(model1, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
  plot(model1, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
  plot(model1, Coral_cover ~ fitted(.), abline = c(0,1))
  
```

* Figure 1b

```{r, warning=FALSE}
#Using raw data (Only thermal regime is significant in model)

Model1_plot <- ggplot(aggr.region, aes(x=Year, y=Coral_cover)) +
  geom_boxplot(aes(group=Year), outlier.shape = NA) +
  stat_boxplot(aes(group=Year), geom = 'errorbar')+
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", colour="red")+
  geom_smooth(span = 0.2, se=T, colour="darkgray")+ 
  #geom_point(aes(colour=Thermal_regime), alpha=0.5) + ylim(0,79) +
  scale_y_continuous("Live coral cover (%)", limits = c(-2, 80), expand = c(0,0))+
  scale_x_continuous("", limits = c(1969, 2015),
                     breaks = seq(1970, 2014, by=2), expand = c(0,0))+
  scale_color_manual(values=my_colours) + labs(title="b")+
  #annotate("text", x = 1983, y = 70, label = "*", size=8)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = 0, ymax = 80,  alpha = .2, fill="red")+
  annotate("rect", xmin = 1972, xmax = 1973, ymin = 0, ymax = 80,  alpha = .2, fill="red")
Model1_plot
```

### Model 2: Time-interval 1 - ENSO.73_82

```{r}
# Time-interval 1 - ENSO.73_82
    model2 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.73_82) 
    summary(model2)
    anova(model2)
    plot(ranef(model2))    
    plot(model2)           
    resnorm2 <- resid(model2)
    hist(resnorm2, xlab = "Residuals", main = "") 
    coef.m2 <- as.data.frame(coef(summary(model2)))    
    
    plot(model2, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model2, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model2, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
    # Note that this first time interval has low number of regions at each year, even the 
    # GLMM model is adjusted, please warning with interpretation/generalization of results
```

* Figure 1c

```{r, warning=FALSE}

#Using raw data (the model is not significant)

Model2_plot <- ggplot(ENSO.73_82, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
  geom_smooth(method = lm, se=FALSE, linetype = "dashed", alpha=1, size=2)+ 
  geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) + 
  scale_y_continuous("Live coral cover (%)", limits = c(0, 80))+
  scale_x_continuous("", limits = c(1973.7, 1982.3),
                     breaks = seq(1974, 1982, by=2), expand = c(0.02,0.02))+
  scale_fill_manual(values=my_colours) +
  scale_colour_manual(values=my_colours)+
  labs(title="c")
Model2_plot

```

### Model 3: Time-interval 3 - ENSO.83_97

```{r}
# Time-interval 3 - ENSO.83_97
    model3 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.83_97) 
    summary(model3)
    anova(model3)
    plot(ranef(model3)) 
    plot(model3)           
    resnorm3 <- resid(model3)
    hist(resnorm3, xlab = "Residuals", main = "") 
    coef.m3 <- as.data.frame(coef(summary(model3)))    
    
    plot(model3, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model3, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model3, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
```

* Extract model 3 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_3 <- expand.grid(Thermal_regime=unique(ENSO.83_97$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.83_97$Year)), (max(ENSO.83_97$Year))))

pred_3 <- predict(model3, newdata=NewData_3, level=0, asList = FALSE)

```

* Figure 1d

```{r, warning=FALSE}

# Using model data 
    Model3b_plot <- ggplot(ENSO.83_97, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
          shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) + 
          scale_y_continuous(" ", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1982.7, 1997.3), 
                             breaks = seq(1983, 1997, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_3, 
                    aes(y=predict(model3, level=0, newdata=NewData_3)), size=2) +
          theme(axis.text.y=element_blank(),  
                    axis.title.y=element_blank(),
                    legend.position = c(0.58, -0.4),
                    legend.title=element_blank(), 
                    legend.text=element_text(size=6),
                    legend.box ="horizontal")+
          guides(col = guide_legend(nrow = 2))+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+
          labs(title="d")
    Model3b_plot

```

### Model 4: Time-interval 4 - ENSO.98_14

```{r}
# Time-interval 4 - ENSO.98_14
    model4 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.98_14) 
    summary(model4)
    anova(model4)
    plot(ranef(model4))    
    plot(model4)           
    resnorm4 <- resid(model4)
    hist(resnorm4, xlab = "Residuals", main = "") 
    coef.m4 <- as.data.frame(coef(summary(model4)))    
    
    plot(model4, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model4, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model4, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))
    
# Competing model with autocorrelation structure
    model4b <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, 
                   data=ENSO.98_14, correlation=corCompSymm(form=~Year|Region)) 
    
    anova(model4, model4b)  # ~ same results
```

* Extract model 4 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_4 <- expand.grid(Thermal_regime=unique(ENSO.98_14$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.98_14$Year)), (max(ENSO.98_14$Year))))

pred_4 <- predict(model4, newdata=NewData_4, level=0)

#summary(pred) 
#length(pred)
```

* Figure 1e

```{r, warning=FALSE}
# Using model data 
    Model4b_plot <- ggplot(ENSO.98_14, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) +
          scale_y_continuous(" ", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1997.7, 2014.3),
                     breaks = seq(1998, 2014, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_4, aes(y=predict(model4, level=0, newdata=NewData_4)), size=2)+
          theme(axis.text.y=element_blank(), axis.title.y=element_blank())+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+    
          labs(title="e")
    Model4b_plot
    
    ```

### Model 5: Time-interval 5 - ENSO.83_14

```{r}
# Time-interval 5 - ENSO.83_14  
    model5 <- lme(Coral_cover ~ -1 + Thermal_regime * Year, random = ~1|Region, data=ENSO.83_14) 
    summary(model5)
    anova(model5)
    plot(ranef(model5))    
    plot(model5)           
    resnorm5 <- resid(model5)
    hist(resnorm5, xlab = "Residuals", main = "") 
    coef.m5 <- as.data.frame(coef(summary(model5))) 
    
    plot(model5, resid(., type = "p") ~ fitted(.) | Region, abline = 0)
    plot(model5, Coral_cover ~ fitted(.) | Region, abline = c(0,1))
    plot(model5, Coral_cover ~ fitted(.) | Thermal_regime, abline = c(0,1))

```

* Extract model 5 predicted values 

```{r}
# Create a new data frame for independent variables  
NewData_5 <- expand.grid(Thermal_regime=unique(ENSO.83_14$Thermal_regime),
                        #Region=unique(aggr.region$Region),
                        Year=seq((min(ENSO.83_14$Year)), (max(ENSO.83_14$Year))))

pred_5 <- predict(model5, newdata=NewData_5, level=0)

```

* Model 5 prediction

```{r, warning=FALSE}
# Using model data 
    Model5b_plot <- ggplot(ENSO.83_14, aes(x=Year, y=Coral_cover, colour=Thermal_regime)) +
          geom_point(aes(fill=factor(Thermal_regime)),
             shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.5) +
          scale_y_continuous("Live coral cover (%)", limits = c(0, 80))+
          scale_x_continuous("", limits = c(1982.7, 2014.3),
                     breaks = seq(1983, 2014, by=2), expand = c(0.02,0.02))+
          geom_line(data=NewData_5, aes(y=predict(model5, level=0, newdata=NewData_5)), size=2)+
          theme(axis.text.y=element_blank(),  
                    axis.title.y=element_blank(),
                    legend.position = c(0.58, -0.3),
                    legend.title=element_blank(), 
                    legend.text=element_text(size=6),
                    legend.direction="horizontal")+
          scale_fill_manual(values=my_colours) +
          scale_colour_manual(values=my_colours)+    
          labs(title="Model 5")
    Model5b_plot
    
```

##  Coral cover multiple comparison between years
* Adjusted p-values for all-pairwise comparisons in a one-way layout
* Set up ANOVA model
* Set up multiple comparisons object for all-pair comparisons
* Multiple comparisons after GLM including interaction terms

```{r, message=FALSE}
library(multcomp)  
```

* Year 1982 vs 1983 (codes 12 vs 13)

```{r}
ENSO.73_97$Year <- as.factor(ENSO.73_97$Year)
comp_years_ENSO.73_97 <- aov(Coral_cover ~ Year + Thermal_regime, data = ENSO.73_97)
m.comp_ENSO.73_97 <- glht(comp_years_ENSO.73_97, linfct = mcp(Year = "Tukey"))
summary(m.comp_ENSO.73_97, test = univariate())

```

* Year 1983 vs 1997 (codes 13 vs 27), and 1997 vs 1998  (codes 27 vs 28)

```{r}
ENSO.83_97$Year <- as.factor(ENSO.83_97$Year)
comp_years_ENSO.83_97 <- aov(Coral_cover ~ Year + Thermal_regime, data = ENSO.83_97)
m.comp_ENSO.83_97 <- glht(comp_years_ENSO.83_97, linfct = mcp(Year = "Tukey"))
summary(m.comp_ENSO.83_97, test = univariate())

```

### FIGURE 1

```{r, warning=FALSE}

Figure1<-grid.arrange(ENSO, Model1_plot, arrangeGrob(
  Model2_plot, Model3b_plot, Model4b_plot, widths = c(3.9/12, 3.80/12, 4.30/12), ncol = 3),
             nrow=3) 
#ggsave(file="Fig1_V7.svg", plot=Figure1, width=6.69, height=6.69)

```

# DHW and coral cover change

```{r, message=FALSE}
# Load packages 
library(tidyverse)
library(dplyr)
library(data.table)
library(RColorBrewer)
```

## Yearly maximum DHW experienced by the best-represented coral reefs sites from 1982 to 2014

* Select and transform DHW data

```{r}
# Select DHW data file: maxDHW.csv
  dhw <- read.csv("Data/maxDHW.csv", header=TRUE)

# Exclude years 1981, and 2017-2019
  dhw <- dhw[!dhw$Year == 1981, ]

# Create groups for plot
  ts.Cano_island <- subset(dhw, dhw$Site == "Cano_island")     
  ts.Uva_island <- subset(dhw, dhw$Site == "Uva_Island")          
  ts.Gorgona_island <- subset(dhw, dhw$Site == "Gorgona_Island")          
  ts.Darwin_island <- subset(dhw, dhw$Site == "Darwin_North_Anchorage")          
  ts.Bahia_Banderas <- subset(dhw, dhw$Site == "Bahia_Banderas")          

```

### FIGURE 2a

* Plot max DHW in each location

```{r}
# Year, maxDHW
  par(oma = c(1,1,1,1)) 
  par(mar = c(4,4,1,1), cex.axis = 1,  las = 1)  
  par(lwd = 1)   
  
  plot(ts.Cano_island$Year,ts.Cano_island$maxDHW,   # Create a white false line with real data
       xlab="Years", ylab="Degree heating weeks (°C-weeks)",  cex=1.5, cex.lab=0.6, col="white",axes = FALSE,
       ylim = c(0, 28), lwd = 1.5) 
  par(new=T)
  rect(1982, 0, 1983.5, 28, col="#fee8c8", border ="#fee8c8")           # Strong ENSO years
  par(new=T)
  rect(1997, 0, 1998.5, 28, col="#fee8c8", border ="#fee8c8")
  par(new=T)
  plot(ts.Cano_island$Year, ts.Cano_island$maxDHW,type="l",              # Thermally stable
  xlab="", ylab="", lwd = 1.5, col="#8c2d04",axes = FALSE,
       ylim = c(0, 28))
  par(new=T)
  plot(ts.Uva_island$Year, ts.Uva_island$maxDHW, type="l",                # Thermally stable
       xlab="", ylab="", lwd = 1.5, col="#feb24c",axes = FALSE,
       ylim = c(0, 28))
  par(new=T)
  plot(ts.Gorgona_island$Year,ts.Gorgona_island$maxDHW, type="l",         # Tropical upwelling
       xlab="", ylab="",lwd = 1.5, col="#fb6a4a", axes = FALSE,
       ylim = c(0, 28))
  par(new=T)
  plot(ts.Darwin_island$Year,ts.Darwin_island$maxDHW, type="l",           # Galapagos
       xlab="", ylab="", lwd = 1.5, col="#9e9ac8",axes = FALSE,
       ylim = c(0, 28))
  par(new=T)
  plot(ts.Bahia_Banderas$Year, ts.Bahia_Banderas$maxDHW, type="l",        # Seasonal
       xlab="", ylab="",lwd = 1.5,col="#a6d96a", axes = FALSE,
       ylim = c(0, 28))
  y <- c(0,4,8,12,16,20,24,28)                                            # Axis
  axis(2,lwd = 0.5, at = y,cex.axis=0.6)
  box(lwd = 0.5)
  x <-c(1982:2014)
  YearsR = as.character(c(1982:2014))
  axis(1,  at = x, labels = YearsR, lwd = 0.4, cex.axis=0.5, las = 2) 
  abline(h=4, col="#525252", lty=2)
  abline(h=8, col="#525252", lty=2)

# Legend
  sites <- c("Thermally stable - Caño Island","Thermally stable - Uva Island",
             "Tropical upwelling - Gorgona Island","Equatorial Upwelling - Darwin Island", 
             "Seasonal - Bahía Banderas")
  par(xpd=TRUE)     
  legend(x = 2000, y = 20, 
         xpd = NA,  # or TRUE 
         inset=c(-0.5,0),
         cex = 0.4,
         legend = sites,         # box categories 
         col = c("#8c2d04","#feb24c","#fb6a4a","#9e9ac8","#a6d96a"),
         lty= 1,
         lwd = 1.5,
         x.intersp = 0.5,
         y.intersp = 2, 
         bty="n")
```

```{r}
 dev.off() # reset parameters for next plot 
```

## Relationship of coral cover rate of change and thermal stress 

* The DHW index measures the accumulated thermal stress above a bleaching threshold for 12 consecutive weeks. 
* At each site, the maximum monthly mean sea surface # temperature (MMM) is calculated from a long-term satellite climatology dataset. 
* Any temperature surpassing the MMM by 1ºC or more is added for 12 consecutive weeks, 
* because temperatures ~1ºC above the MMM are known to cause coral bleaching (Liu et al., 2006).  
* For example, if the water temperature during four consecutive weeks exceeds the MMM in 1.3°C, # 1.1°C, 1.2°C, and 1.4°C, then,
* the site accumulates 5°C-weeks when these anomalies are summed. 

 We tested the hypothesis that the strength of the Log_annual_rate_of_change (response variable) 
 is a function of the maxDHW experienced. We had measured the rate of change from four Thermal regimes, 
 and fitted Thermal regimes as a random intercept, and estimate a common slope (change in the rate of change) 
 for maxDHW across all Thermal regimes by fitting it as a fixed effect.

```{r, message=FALSE}
## Load data
  roc.cover <- read.csv("Data/RoC_DHW.csv", header=TRUE)  ### Select file:  RoC_DWH.csv

# Load packages
  library(lme4)
  library(lmerTest)
  library(MuMIn)
```

* Model 6: coral cover change and DHW 

```{r}
model6 <- lmerTest::lmer(Log_annual_rate_of_change ~ maxDHW + (1|Thermal_regime), data=roc.cover)
step(model6)
summary(model6) 
r.squaredGLMM(model6)   #  returns the marginal and the conditional R2
# marginal R2  describes the proportion of variance explained by the fixed factor(s) alone:
# conditional R2 describes the proportion of variance explained by both the fixed and random factors
# Nakagawa, S. & Schielzeth, H. (2013). 

```


### FIGURE 2B: Relationship of coral cover rate of change and thermal stress

```{r, message=FALSE}
# Load packages
  library(tidyverse)
  library(dplyr)
  library(data.table)
  library(RColorBrewer)
 
# Create groups for plot
  Seasonal          = subset(roc.cover, roc.cover$Thermal_regime == "Seasonal")          
  Thermally_Stable  = subset(roc.cover, roc.cover$Thermal_regime == "Thermally_Stable")  
  Tropical_Upwelling = subset(roc.cover, roc.cover$Thermal_regime == "Upwelling") 
  Galapagos         = subset(roc.cover, roc.cover$Thermal_regime == "Galapagos_Islands") 

# Plot
  par(oma = c(1,1,1,1)) 
  par(mar = c(4,4,1,1), cex.axis = 1,  las = 1) 
  par(lwd = 1)
  plot (Seasonal$maxDHW, Seasonal$Log_annual_rate_of_change,
        pch = 21, lwd = 0.5, bg = "#a6d96a93", col="black", axes = FALSE,
        cex=1.5,cex.lab=0.6,
        xlim = c(0,30), ylim = c(-1.75, 1),
        xlab = "Degree heating weeks (°C-weeks)",
        ylab = "Annual rate of change in coral cover")
  par(new=T); 
  plot (Thermally_Stable$maxDHW, Thermally_Stable$Log_annual_rate_of_change,
        xlab="", ylab="", pch = 21, lwd = 0.5, col="black", bg = "#feb24c93", axes = FALSE,
        cex=1.5,cex.lab=0.6,
        xlim = c(0,30), ylim = c(-1.75, 1))
  par(new=T); 
  plot (Tropical_Upwelling$maxDHW, Tropical_Upwelling$Log_annual_rate_of_change,
        xlab="", ylab="", pch = 21, lwd = 0.5, bg = "#fb6a4a93",col="black", axes = FALSE,
        cex=1.5,cex.lab=0.6,
        xlim = c(0,30), ylim = c(-1.75, 1))
  par(new=T); 
  plot (Galapagos$maxDHW, Galapagos$Log_annual_rate_of_change,
        xlab="", ylab="", pch = 21, lwd = 0.5, bg = "#9e9ac893",col="black", axes = FALSE,
        cex=1.5,cex.lab=0.6,
        xlim = c(0,30), ylim = c(-1.75, 1))
  box(lwd = 0.5)
  x <-c(0,5,10,15,20,25,30)
  axis(1, lwd = 0.5, at = x, cex.axis = 0.5)
  y <- c(-1.5,-1.0,-0.5,0,0.5,1)
  axis(2,lwd = 0.5, at = y, cex.axis = 0.5)
  abline(v=4, col="#525252", lty=2); abline(v=8, col="#525252", lty=2); abline(h=0, col="#525252", lty=2); 
  # Axis text I, II, III, IV
  text(3.5, 0.3, "II", cex = 0.6); text(5, 0.3, "I", cex = 0.6)
  text(3.5, - 0.3, "III", cex = 0.6); text(5, -0.3, "IV", cex = 0.6)
  
  par(xpd=TRUE) 
  legend(x = 10, y = -0.5, 
         xpd = NA,   
         inset=c(-0.5,0),
         legend = c("Equatorial Upwelling", "Thermally stable", "Tropical upwelling","Seasonal"),
         pch=21,
         pt.bg = c("#9e9ac8","#fb6a4a","#fb6a4a","#a6d96a"),
         x.intersp = 0.5,
         y.intersp = 2, 
         bty="n")
```


```{r}
 dev.off() # reset parameters for next plot 
```

## Descriptives statistics heat stress

No stress 

```{r}
no.stress <- subset(roc.cover, maxDHW < 4)                      #subset of DHW < 4
length(no.stress$maxDHW)/length(roc.cover$maxDHW)               # ratio no stress: total              
1- length(no.stress$maxDHW)/length(roc.cover$maxDHW)               # ratio stress: total              
positive.rate <- subset(no.stress, Log_annual_rate_of_change > 0)   #subset of Rate > 0
length(positive.rate$Log_annual_rate_of_change)                     # Number of observations in 
negative.rate <- subset(no.stress, Log_annual_rate_of_change < 0)   #subset of Rate > 0
length(negative.rate$Log_annual_rate_of_change)                     # Number of observations in 
```

No stress seasonal

```{r}
no.stress.seasonal <- subset(no.stress, Thermal_regime == "Seasonal")   
positive.rate <- subset(no.stress.seasonal, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.seasonal, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)   

```

No stress upwelling

```{r}
no.stress.upwelling <- subset(no.stress, Thermal_regime == "Upwelling")
positive.rate <- subset(no.stress.upwelling, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.upwelling, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

No stress thermally stable

```{r}
no.stress.Thermally_Stable <- subset(no.stress, Thermal_regime == "Thermally_Stable")   
positive.rate <- subset(no.stress.Thermally_Stable, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.Thermally_Stable, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

No stress Galapagos

```{r}
no.stress.Galapagos_Islands <- subset(no.stress, Thermal_regime == "Galapagos_Islands") 
positive.rate <- subset(no.stress.Galapagos_Islands, Log_annual_rate_of_change > 0)  
negative.rate <- subset(no.stress.Galapagos_Islands, Log_annual_rate_of_change < 0)  
length(positive.rate$Log_annual_rate_of_change)/length(negative.rate$Log_annual_rate_of_change)  

```

# Supplementary figures

```{r, message=FALSE}
library(pals)
library(dplyr)
library(reshape2)
library(RColorBrewer) 
```

### FIGURE S2: a) Number of regions surveyed per year, b): Number of countries surveyed per year
```{r}
# Barplot number of surveys per year
  obs_num = as.data.frame(table(cover$Year,cover$Region))    
  colnames(obs_num) = c("Year", "Region", "Freq")
  wide_obs_num = dcast(obs_num, Region~Year, value = "Freq")  
  df = data.matrix(wide_obs_num[,2:45])   
  as.table(df)     
  df[ df>1 ] <- 1 
  levels(cover$Region) # How many regions? = how many colours
  Regions <- c(levels(obs_num$Region))
  color.regions = warmcool(17)
  
  # Figure 2a
  par(mfcol=c(2,1), cex.main = 1.5, mar = c(4,4,1,1), cex.lab = 1.5, cex.axis = 1,  las = 1)
  barplot(df,
          ylim=c(0,15),
          col = color.regions,   
          ylab="Number of regions surveyed per year",  
          xlab="Year",
          #lwd = 1,          
          las = 2,           
          axis.lty = 1, 
          cex.names = 0.4,   
          cex.axis = 0.8)
# Legend as a box
  legend( #"bottomright",    
     x = 2, y = 16, 
     xpd = NA,  # or TRUE 
     legend = Regions,          
     fill = color.regions[1:17],   
     inset=c(-0.5,0),
     cex = 0.35,
     text.font=0.5,            
     x.intersp = -0.5,
     y.intersp = 1,
     lwd = 0.1,
     bty="n")

# Figure 2b
obs_num = as.data.frame(table(cover$Year,cover$Country))    # Table per country
colnames(obs_num) = c("Year", "Country", "Freq")
wide_obs_num = dcast(obs_num, Country~Year, value = "Freq")   
dfc = data.matrix(wide_obs_num[,2:45])   
as.table(dfc)       
dfc[ dfc>1 ] <- 1 # replace all values greater than one with one
color.countries <- brewer.pal(9, "Oranges")
countries = c(levels(obs_num$Country))
barplot(dfc,
        col = color.countries,   
        ylim=c(0,10),
        ylab="Number of countries surveyed per year",  
        xlab="Year",
        las = 2,           
        axis.lty = 1,      
        cex.names = 0.4,   
        cex.axis = 0.8)
# Legend as a box
legend( #"bottomright",    
   x = 2, y = 10, 
   xpd = NA,  # or TRUE 
   legend = countries,         
   fill = color.countries[1:9],   
   inset=c(-0.5,0),
   cex = 0.35,
   text.font=1,            
   x.intersp = -0.5,
   y.intersp = 1,
   lwd = 0.1,
   bty="n")

```


```{r}
 dev.off() # reset parameters for next plot 
```

### FIGURE S3: Variation in the live coral cover for 1970–2014 per thermal regime 

Temporal variation in the live coral cover for 1970–2014. 
* (a) Tropical upwelling regime. 
* (b) Seasonal regime. 
* (c) Thermally stable regime. 
* (d) Equatorial upwelling regime. 
The smooth line represents the best fit to the time series with a 95% confidence level interval and a span = 0.3.

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(lemon)

aggr.region$Thermal_regime<-factor(aggr.region$Thermal_regime, 
                                  levels=c("Tropical upwelling", "Seasonal", 
                                           "Thermally stable", "Equatorial upwelling"),
                                  labels = c ("a", "b", "c", "d"))
                                   
summary(aggr.region$Thermal_regime)

FigureS3<-ggplot(aggr.region, aes(x=Year, y=Coral_cover)) + 
  theme_bw() + theme(panel.border = element_blank(),   # set ggplot to white background
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(),
                              strip.background = element_blank(),
                              strip.text = element_text(face="bold",hjust = 0, vjust = -1))+
  geom_point()+ geom_smooth (span = 0.3) +
  scale_x_continuous(limits=c(1970, 2014), 
                     breaks = seq(1970, 2014, by=5),
                     expand = c(0.01, 0.01), "Year") +
  scale_y_continuous(limits=c(-19, 91), expand = c(0, 0), "Live coral cover (%)") +
  facet_wrap(Thermal_regime~., ncol=1, scales = "free_x", strip.position ="top")
FigureS3
#ggsave(file="FigureS3.svg", plot=FigureS3, width=6.69, height=6.69)
```
